---
title: "SKU*Forecast Série Temporal"
output: html_notebook
---
  ### Carrega fun??es auxiliares e credenciais de acesso ?s bases de dados
```{r}
### Carrega fun??es auxiliares e credenciais de acesso ?s bases de dados
setwd("C:\\Users\\rafael.dias\\Documents\\R_Docs") 

user_dw='rafael.dias'
password_dw='7d@0^&TJEq@4MZ5u'
dbname_dw='bi_dw'
host_dw='dw.madeiramadeira.com.br'
#data <- run_query(query_dw, user_dw, password_dw, dbname_dw, host_dw)

# Função que executa uma query no banco MySQL especificado, com as credenciais especificadas
library(RMySQL)
run_query <- function(query, user, password, dbname, host) {
  conDW <- dbConnect(MySQL(), user=user, password=password, dbname=dbname, host=host)
  estrutura <- dbSendQuery(conDW, paste(query, sep = ""))
  data <- fetch(estrutura, n = -1)
  huh <- dbHasCompleted(estrutura)
  dbClearResult(estrutura)
  dbDisconnect(conDW)
  data
}
```

```{r}
query_dw <- "
SELECT 
    id_produto,
    macro_categoria,
    F.nome,
    F.marca,
    F.matriz,
    F.preco_produto,
    F.disponivel,
    FA.cor,
    SUM(quantidade) qt_produto,
    SUM(receita_produto) / SUM(quantidade) preco_medio,
    CONCAT(ano, LPAD(WEEK(ped_dta_compra), 2, '0')) ano_sem,
    CONCAT(ano, '/', mes, '/', dia) dt_ajust
FROM
    dw_vendas V
        LEFT JOIN
    bi_dw.fc_produto F ON V.id_produto = F.id_prdprd
        LEFT JOIN
    bi_dw.fc_produto_atributos FA ON V.id_produto = FA.id_prdprd
WHERE
    ped_dta_compra BETWEEN '2016-09-26' AND '2018-09-29'
        AND id_produto IN (18551,
        18552,
        18554,
        19989,
        19990,
        19991,
        19993,
        19994,
        20439,
        20461,
        20462,
        20463,
        20464,
        21109,
        21110,
        21111,
        21112,
        21113,
        21114,
        21115,
        21116,
        22471,
        22472,
        22473,
        22474,
        22475,
        26784,
        26787,
        26797,
        26802,
        34260,
        34467,
        39547,
        51483,
        51857,
        51858,
        51861,
        51862,
        51880,
        51881,
        51893,
        51900,
        51901,
        63170,
        68873,
        68874,
        68875,
        68876,
        68877,
        68878,
        68879,
        68880,
        68881,
        68985,
        69131,
        69132,
        69133,
        69134,
        69155,
        69156,
        69157,
        69158,
        73479,
        75383,
        76400,
        92970,
        92971,
        92972,
        93139,
        98422,
        98423,
        98424,
        98425,
        98426,
        101767,
        106496,
        107290,
        107585,
        108916,
        108917,
        108918,
        108919,
        108920,
        111112,
        111113,
        111114,
        111115,
        111116,
        111117,
        111118,
        111119,
        112478,
        112492,
        112493,
        112508,
        112511,
        112525,
        112526,
        118009,
        118010,
        118011,
        119099,
        126740,
        129366,
        129367,
        129368,
        129384,
        129385,
        129386,
        134288,
        139055,
        139056,
        139057,
        139058,
        139059,
        139060,
        139061,
        141100,
        142079,
        142080,
        142081,
        142864,
        143036,
        143037,
        143038,
        143039,
        143767,
        144199,
        145614,
        146247,
        146248,
        146249,
        146250,
        146251,
        146252,
        146253,
        146254,
        146255,
        146869,
        146870,
        146871,
        146872,
        146873,
        146874,
        146875,
        146876,
        146880,
        146881,
        146882,
        146894,
        148374,
        148375,
        148376,
        149738,
        150404,
        151185,
        151668,
        154370,
        155884,
        155885,
        155886,
        155887,
        155900,
        155901,
        155902,
        155903,
        155912,
        155913,
        155914,
        155915,
        155924,
        155925,
        155926,
        155927,
        155938,
        155940,
        155943,
        155944,
        156596,
        156597,
        156605,
        156606,
        156607,
        156608,
        157278,
        157279,
        157280,
        157315,
        157316,
        157317,
        157318,
        157319,
        157320,
        157321,
        157322,
        157338,
        157339,
        157340,
        157341,
        157342,
        157343,
        157344,
        157345,
        157346,
        157553,
        157554,
        157555,
        157556,
        157570,
        157580,
        157581,
        157582,
        157583,
        157698,
        157699,
        157700,
        157701,
        157935,
        157936,
        157937,
        157938,
        157939,
        157940,
        157941,
        157942,
        159065,
        159066,
        159067,
        159068,
        159069,
        159070,
        159071,
        159072,
        159073,
        159841,
        159842,
        159843,
        159846,
        159847,
        159848,
        159849,
        159899,
        160695,
        160696,
        160795,
        162068,
        162702,
        162703,
        162781,
        162782,
        162812,
        162813,
        165999,
        166998,
        167063,
        167064,
        167068,
        167467,
        167469,
        167707,
        168818,
        168819,
        168912,
        168914,
        169439,
        169466,
        169467,
        169468,
        169469,
        169470,
        169471,
        169472,
        169473,
        170143,
        170144,
        170184,
        171267,
        171268,
        172178,
        172599,
        172600,
        172601,
        172656,
        172657,
        172659,
        172660,
        172898,
        172920,
        172923,
        173013,
        173014,
        173015,
        173020,
        173021,
        173507,
        173508,
        173509,
        173510,
        173511,
        173512,
        173513,
        173514,
        173515,
        173516,
        173517,
        173718,
        173719,
        173792,
        173793,
        173794,
        173795,
        173796,
        173797,
        173798,
        173799,
        174027,
        174028,
        174029,
        174030,
        174076,
        174077,
        174894,
        174910,
        174911,
        175000,
        175063,
        175148,
        175274,
        175281,
        175886,
        175887,
        175888,
        175889,
        175890,
        175891,
        175892,
        176779,
        176780,
        176781,
        176782,
        176783,
        176784,
        176785,
        176786,
        176787,
        176788,
        176789,
        176790,
        176791,
        176796,
        176797,
        176798,
        176799,
        176811,
        177643,
        178087,
        178472,
        178593,
        178850,
        178962,
        178963,
        178964,
        178965,
        179005,
        179006,
        179007,
        179008,
        179031,
        179032,
        179033,
        179067,
        179068,
        179069,
        179070,
        179071,
        179072,
        179074,
        179108,
        179109,
        179110,
        179119,
        179120,
        179121,
        179122,
        179123,
        179500,
        181163,
        181333,
        181334,
        181335,
        181336,
        181337,
        181338,
        181339,
        181340,
        181341,
        181595,
        181603,
        181643,
        181651,
        182119,
        182120,
        182121,
        182122,
        182123,
        182124,
        182125,
        182126,
        182127,
        182128,
        182129,
        182130,
        182131,
        182132,
        182133,
        182134,
        182263,
        182362,
        182363,
        182500,
        182501,
        182502,
        182503,
        182504,
        182505,
        182506,
        182507,
        182697,
        182870,
        183399,
        183400,
        183401,
        183402,
        183782,
        183783,
        183784,
        183785,
        184005,
        184006,
        184007,
        184008,
        184009,
        184010,
        184011,
        184012,
        184013,
        184014,
        184015,
        184016,
        184025,
        184026,
        184027,
        184028,
        184029,
        184030,
        184031,
        184032,
        184033,
        184034,
        184035,
        184036,
        184037,
        184038,
        184039,
        184040,
        184041,
        184042,
        184043,
        184044,
        184045,
        184046,
        184047,
        184048,
        184049,
        186166,
        186167,
        186168,
        186169,
        186170,
        186171,
        186172,
        186173,
        186174,
        186175,
        188611,
        188612,
        189503,
        189504,
        191902,
        191903,
        191904,
        192090,
        192091,
        192092,
        192093,
        192094,
        192095,
        192096,
        192097,
        192098,
        192099,
        192108,
        192109,
        192110,
        192111,
        192112,
        192113,
        192114,
        192341,
        192342,
        192343,
        192439,
        192446,
        192450,
        192453,
        192466,
        192470,
        192472,
        192473,
        192475,
        192481,
        192494,
        192495,
        192498,
        192499,
        192506,
        192939,
        192940,
        192966,
        194069,
        194070,
        194337,
        194338,
        194339,
        194558,
        194559,
        194560,
        194845,
        194846,
        194847,
        194851,
        194852,
        194853,
        194880,
        194881,
        194882,
        194898,
        194899,
        194900,
        194907,
        194908,
        194909,
        195128,
        195129,
        195192,
        195193,
        195194,
        195195,
        195200,
        195201,
        195231,
        195232,
        195262,
        195263,
        195499,
        195500,
        195501,
        195502,
        195503,
        195504,
        195505,
        195506,
        195507,
        195508,
        195509,
        195510,
        195511,
        195680,
        195681,
        195682,
        195683,
        195684,
        195685,
        195984,
        195985,
        195986,
        195987,
        196076,
        196077,
        196078,
        196088,
        196089,
        196090,
        196315,
        196316,
        196317,
        196318,
        196319,
        196320,
        196677,
        196679,
        196680,
        197650,
        197716,
        197717,
        197718,
        197719,
        197796,
        197797,
        197798,
        197799,
        197800,
        197801,
        197802,
        197803,
        198076,
        198077,
        198078,
        198079,
        198080,
        198081,
        198383,
        198384,
        198401,
        198402,
        198405,
        198406,
        198407,
        198408,
        199651,
        199652,
        199653,
        199654,
        199697,
        199698,
        199705,
        199706,
        199714,
        199897,
        199898,
        199899,
        199900,
        199901,
        199909,
        199910,
        199911,
        199912,
        201264,
        201447,
        201448,
        201449,
        201450,
        201451,
        201452,
        201453,
        201454,
        201455,
        201656,
        201657,
        201658,
        201659,
        201660,
        201661,
        201662,
        201663,
        201664,
        201665,
        201711,
        201712,
        201713,
        201714,
        201715,
        201716,
        201719,
        201969,
        201981,
        201982,
        201983,
        202289,
        202794,
        202795,
        202796,
        204512,
        204513,
        204514,
        204515,
        204516,
        204517,
        204657,
        204658,
        205064,
        205065,
        205066,
        205067,
        205068,
        205613,
        205614,
        205705,
        205706,
        205707,
        205708,
        205709,
        205710,
        205711,
        205712,
        206244,
        206245,
        206246,
        206247,
        206248,
        206249,
        206250,
        206251,
        206252,
        206253,
        206254,
        206255,
        206256,
        206257,
        206356,
        206357,
        206358,
        206359,
        207118,
        207119,
        207122,
        207123,
        207193,
        207254,
        207255,
        207256,
        207257,
        207258,
        207259,
        207260,
        207261,
        207262,
        208363,
        208364,
        208365,
        208366,
        208367,
        208368,
        208369,
        208370,
        208371,
        208372,
        208373,
        208374,
        208375,
        208376,
        208377,
        208378,
        208379,
        208380,
        208381,
        208385,
        208386,
        208387,
        208388,
        208389,
        208390,
        208457,
        208458,
        208459,
        208460,
        208461,
        208462,
        208463,
        208464,
        208465,
        208466,
        208467,
        208468,
        208469,
        208470,
        208471,
        208472,
        208473,
        208474,
        208522,
        208523,
        208524,
        208525,
        208526,
        208527,
        208528,
        208529,
        208530,
        208531,
        208532,
        208533,
        208534,
        208535,
        208536,
        208537,
        208538,
        208539,
        208540,
        208541,
        208542,
        208543,
        208544,
        208545,
        208546,
        208547,
        208548,
        208549,
        208665,
        208666,
        208667,
        208668,
        208669,
        208670,
        208671,
        208672,
        208673,
        208674,
        208675,
        208676,
        208677,
        208678,
        208679,
        208680,
        208681,
        208682,
        208683,
        208684,
        208685,
        208686,
        208687,
        208688,
        208689,
        208690,
        208691,
        208692,
        208749,
        208750,
        210340,
        210341,
        210342,
        210343,
        210344,
        210422,
        210423,
        210424,
        210428,
        210430,
        210431,
        210432,
        210451,
        210453,
        210454,
        210455,
        210457,
        210458,
        211499,
        211672,
        211674,
        211675,
        211676,
        211677,
        211678,
        211888,
        211897,
        212084,
        212085,
        212086,
        214095,
        214098,
        214169,
        214866,
        214867,
        215471,
        215497,
        215498,
        215499,
        215500,
        215501,
        215502,
        215503,
        215504,
        215505,
        215506,
        215507,
        215508,
        215509,
        215510,
        215511,
        215512,
        215513,
        215514,
        215515,
        215516,
        215517,
        215518,
        215519,
        215520,
        215521,
        215522,
        215523,
        215524,
        215525,
        215526,
        215527,
        215528,
        215529,
        215530,
        215531,
        215532,
        215855,
        215960,
        217251,
        217252,
        217255,
        217256,
        217611,
        217612,
        217779,
        217783,
        217784,
        217785,
        217786,
        217787,
        217788,
        217797,
        217798,
        217799,
        217832,
        217833,
        217848,
        217913,
        217915,
        217916,
        217970,
        217971,
        218057,
        218058,
        218059,
        218060,
        218061,
        218062,
        218063,
        218064,
        218065,
        218066,
        218067,
        218068,
        218069,
        218070,
        218071,
        218072,
        218078,
        218079,
        218080,
        218081,
        218130,
        218131,
        218132,
        218133,
        218134,
        218135,
        218136,
        218137,
        218138,
        218139,
        218140,
        218141,
        218142,
        218143,
        218144,
        218145,
        218741,
        218742,
        218743,
        218744,
        218745,
        218746,
        218747,
        218748,
        218749,
        218750,
        218854,
        218855,
        218856,
        218857,
        218858,
        218859,
        218860,
        218861,
        218862,
        218863,
        218864,
        218865,
        218866,
        218868,
        218869,
        218870,
        218871,
        218872,
        218873,
        218874,
        218875,
        218876,
        218877,
        218878,
        218879,
        218880,
        218881,
        218882,
        218883,
        218884,
        218885,
        219326,
        219355,
        219367,
        219368,
        220875,
        220876,
        220877,
        221427,
        221466,
        221469,
        221471,
        221560,
        221564,
        221836,
        221837,
        221866,
        221867,
        222456,
        223066,
        223067,
        223554,
        223800,
        228371,
        229112,
        230948,
        230949,
        232915,
        232916,
        233082,
        233140,
        233335,
        233827,
        233828,
        233843,
        233844,
        233845,
        237878,
        237879,
        237880,
        237881,
        237882,
        237883,
        237884,
        237885,
        237886,
        237887,
        237888,
        237889,
        237890,
        237891,
        237892,
        237893,
        238455,
        238871,
        239060,
        239512,
        239513,
        239528,
        239540,
        239541,
        239922,
        239923,
        239924,
        239925,
        240020,
        240021,
        240367,
        240368,
        240585,
        240586,
        240646,
        240655,
        240656,
        240657,
        240806,
        240807,
        240808,
        242734,
        242735,
        242736,
        242737,
        242822,
        242823,
        242824,
        242825,
        242826,
        242827,
        242942,
        243038,
        243039,
        243714,
        243715,
        243716,
        243717,
        243752,
        243753,
        243900,
        244402,
        244436,
        244441,
        248778,
        248830,
        248882,
        248883,
        248884,
        248887,
        248888,
        248889,
        249168,
        249169,
        249262,
        249263,
        249264,
        249265,
        249481,
        249482,
        249483,
        249484,
        249485,
        249486,
        249487,
        249488,
        249489,
        249490,
        250344,
        250345,
        250346,
        251072,
        251073,
        251074,
        251075,
        251086,
        251087,
        251098,
        251099,
        252263,
        253078,
        253079,
        253080,
        253657,
        253660,
        253729,
        253730,
        253731,
        253732,
        253733,
        253756,
        253833,
        253834,
        253867,
        253869,
        254173,
        254439,
        254440,
        254678,
        254679,
        254680,
        254681,
        255181,
        255182,
        255183,
        255184,
        255185,
        255269,
        255270,
        255271,
        255576,
        255577,
        255578,
        255579,
        255580,
        255581,
        255582,
        255583,
        255584,
        255657,
        255770,
        255832,
        255833,
        255834,
        256167,
        256168,
        256169,
        256180,
        256181,
        256182,
        257278,
        257279,
        257280,
        257819,
        257820,
        257821,
        257842,
        257845,
        257849,
        257850,
        257851,
        257852,
        257855,
        257857,
        257861,
        257862,
        257864,
        257866,
        257867,
        257869,
        257871,
        257873,
        257875,
        257877,
        257880,
        257881,
        258283,
        258284,
        258285,
        258286,
        258544,
        258592,
        259023,
        259024,
        259025,
        259026,
        259027,
        259028,
        259029,
        259030,
        259031,
        259032,
        259033,
        259034,
        259035,
        259036,
        259037,
        259038,
        259039,
        259040,
        259041,
        259042,
        259043,
        259044,
        259045,
        259046,
        259047,
        259048,
        259049,
        259050,
        259051,
        259052,
        259175,
        259176,
        259881,
        259882,
        261166,
        261167,
        262239,
        262240,
        262241,
        262242,
        262243,
        262244,
        262245,
        262246,
        262247,
        262248,
        262249,
        262471,
        262472,
        263693,
        265181,
        266512,
        266591,
        266592,
        266876,
        266967,
        266968,
        266969,
        266970,
        267286,
        267287,
        267288,
        267289,
        267290,
        267291,
        267292,
        267293,
        267294,
        267295,
        267296,
        267297,
        268025,
        269034,
        269042,
        271803,
        272416,
        272417,
        273943,
        273944,
        273945,
        273946,
        273947,
        274032,
        274033,
        274045,
        274710,
        274711,
        275349,
        275760,
        275802,
        275803,
        276374,
        276696,
        276697,
        276748,
        276749,
        276750,
        276751,
        276752,
        276753,
        276754,
        276755,
        276756,
        276757,
        276758,
        276759,
        276760,
        276761,
        276770,
        276771,
        276772,
        276773,
        276774,
        276775,
        276776,
        276777,
        276778,
        276779,
        276780,
        276781,
        276782,
        276783,
        276784,
        276785,
        277139,
        277452,
        277453,
        277465,
        277466,
        277477,
        277478,
        277708,
        277710,
        277711,
        278102,
        278103,
        278104,
        278105,
        278203,
        278204,
        278205,
        278456,
        278472,
        278490,
        278491,
        278492,
        278493,
        278494,
        278849,
        278850,
        278851,
        278852,
        278853,
        278947,
        278969,
        278987,
        279027,
        279028,
        279029,
        279030,
        279071,
        279153,
        279154,
        279155,
        279161,
        279162,
        279163,
        279284,
        279285,
        279286,
        279287,
        279288,
        279289,
        279290,
        279291,
        279292,
        279293,
        279294,
        279405,
        279465,
        279466,
        279525,
        279604,
        279812,
        279813,
        279818,
        279819,
        280048,
        280049,
        280051,
        280052,
        280304,
        280305,
        280306,
        280307,
        280308,
        280403,
        280739,
        280741,
        280757,
        281670,
        281671,
        281672,
        281675,
        281710,
        281711,
        281712,
        281727,
        281728,
        281729,
        281798,
        281801,
        281820,
        281821,
        281877,
        281878,
        281879,
        281880,
        282203,
        282580,
        282581,
        283063,
        283135,
        283136,
        283137,
        283138,
        283280,
        283528,
        283529,
        283530,
        283535,
        283719,
        283757,
        283872,
        283880,
        283881,
        283882,
        284313,
        284314,
        285032,
        285033,
        286301,
        286314,
        286315,
        286316,
        286317,
        289463,
        289464,
        289465,
        289466,
        289467,
        289468,
        291357,
        304945,
        305253,
        305267,
        305330,
        305331,
        309920,
        311305,
        311348,
        311814,
        324844,
        324845,
        326364,
        326390,
        326392,
        326393,
        326396,
        328351,
        329932,
        329933,
        329934,
        331158,
        331159,
        331160,
        331161,
        387567,
        387568,
        387875,
        387876,
        405359,
        405360,
        429412,
        429413,
        429414,
        63246,
        63247,
        63248,
        63249,
        63250,
        63251,
        63252,
        63253,
        63254,
        63255,
        63256,
        63257,
        74953,
        75381,
        97053,
        97054,
        97055,
        98410,
        98411,
        98412,
        98413,
        111966,
        111967,
        111968,
        111969,
        111970,
        111971,
        113610,
        123168,
        134293,
        143335,
        149625,
        160794,
        160808,
        162777,
        162778,
        166262,
        166263,
        166264,
        166265,
        167499,
        167500,
        167501,
        167502,
        167503,
        167504,
        167505,
        167506,
        167507,
        167508,
        167509,
        167510,
        169125,
        169126,
        169127,
        169128,
        169173,
        172847,
        175785,
        178112,
        178922,
        178995,
        178996,
        178997,
        179451,
        183733,
        186372,
        186373,
        186374,
        189606,
        194836,
        194837,
        194838,
        194839,
        194840,
        194841,
        194904,
        194905,
        194906,
        196040,
        196041,
        196042,
        196043,
        201456,
        201457,
        201458,
        202293,
        202305,
        202329,
        207120,
        207121,
        210366,
        210367,
        210368,
        210369,
        210370,
        210371,
        211439,
        211501,
        211502,
        214291,
        214292,
        214297,
        214298,
        217901,
        217902,
        217903,
        217904,
        217905,
        217921,
        218094,
        218111,
        218112,
        218113,
        218114,
        218115,
        218116,
        218120,
        218121,
        218122,
        218123,
        218124,
        218125,
        218126,
        218127,
        218128,
        218129,
        219778,
        219779,
        222444,
        233127,
        233128,
        233129,
        233130,
        233131,
        233132,
        233133,
        233134,
        233138,
        242756,
        242757,
        242758,
        242759,
        248436,
        248557,
        248997,
        250229,
        250230,
        250317,
        250318,
        250319,
        252530,
        253658,
        253860,
        254264,
        254276,
        254290,
        260333,
        267367,
        267371,
        268978,
        268979,
        268980,
        268981,
        268982,
        269166,
        276727,
        276728,
        277872,
        277873,
        277874,
        277875,
        278826,
        278827,
        278828,
        278829,
        278830,
        278967,
        278968,
        280026,
        280028,
        280029,
        280030,
        280031,
        280032,
        280840,
        280841,
        280842,
        280843,
        280844,
        281972,
        283865,
        301912,
        301913,
        310012,
        310013,
        319978,
        324900,
        324901,
        324902,
        324903,
        327482,
        329350,
        329351,
        329352,
        363689,
        369542,
        415347,
        415348,
        415363,
        20437,
        34250,
        40893,
        40894,
        43926,
        49182,
        49183,
        51484,
        75717,
        75718,
        102512,
        107289,
        132194,
        146313,
        146314,
        146315,
        146316,
        147544,
        155775,
        155776,
        157886,
        159827,
        159828,
        159829,
        159830,
        159831,
        159832,
        164580,
        164581,
        165835,
        165836,
        165837,
        168149,
        170028,
        172583,
        172584,
        172585,
        177039,
        177050,
        182669,
        188600,
        188601,
        188602,
        188603,
        188604,
        188605,
        192056,
        192057,
        192133,
        192134,
        192135,
        192136,
        192137,
        192138,
        192139,
        192140,
        195023,
        195345,
        195346,
        195586,
        199711,
        200771,
        200772,
        200774,
        201866,
        202298,
        202309,
        202331,
        212835,
        212836,
        212837,
        212838,
        214021,
        214022,
        217253,
        217254,
        219709,
        219710,
        219711,
        223511,
        241033,
        241034,
        242888,
        243767,
        250359,
        250360,
        250361,
        253656,
        253866,
        265182,
        268027,
        268028,
        268029,
        268030,
        275343,
        275344,
        278729,
        278730,
        278931,
        278932,
        278933,
        278934,
        278935,
        278936,
        278937,
        278938,
        278939,
        278940,
        278941,
        278942,
        278943,
        278944,
        278945,
        278946,
        279539,
        279540,
        279541,
        279542,
        281344,
        281363,
        281364,
        282643,
        282644,
        282645,
        283410,
        283411,
        283653,
        283654,
        283655,
        283656,
        287980,
        292612,
        292613,
        310063,
        310065,
        311385,
        311391,
        311392,
        311393,
        311394,
        311395,
        311396,
        329359,
        329360,
        329361,
        337160,
        337161,
        337162,
        337593,
        337594,
        337595,
        340834,
        343793,
        343794,
        343795,
        343796,
        343797,
        347729,
        352905,
        352906,
        352907,
        352908,
        362083,
        362084,
        362085,
        362086,
        362087,
        362088,
        362111,
        362112,
        362113,
        362114,
        362115,
        362116,
        362132,
        362133,
        362134,
        362135,
        362136,
        362137,
        364063,
        369533,
        370825,
        370832,
        370834,
        370835,
        370843,
        370847,
        370848,
        370849,
        371149,
        371161,
        371246,
        371252,
        371256,
        371264,
        371304,
        371305,
        371398,
        372577,
        372597,
        372600,
        372606,
        372609,
        385156,
        385158,
        385219,
        385225,
        415362,
        442936,
        453474,
        453529,
        453530,
        453554,
        454161,
        454162,
        454163,
        454164,
        454165,
        462659,
        471017,
        291735,
        291759,
        292192,
        292195,
        292292,
        292294,
        292315,
        292324,
        292420,
        292421,
        385165,
        254269,
        369723,
        350137,
        181078,
        279356,
        189514,
        112504,
        111054,
        224883,
        404964,
        348212,
        283878,
        249686,
        250566,
        239062,
        279608,
        287963,
        279610,
        281370,
        283201,
        248879,
        281368,
        286156,
        279609,
        250558,
        248880,
        249105,
        290205,
        283202,
        248878,
        379744,
        239061,
        281369,
        264672,
        264673,
        239065,
        332864,
        379773,
        249106,
        293884,
        239066,
        283190,
        283189,
        308980,
        293888,
        239063,
        311812,
        293896,
        239064,
        332865,
        379777,
        311825,
        332866,
        249107,
        311773,
        308981,
        279082,
        279080,
        279085,
        279086,
        279081,
        279100,
        279094,
        279083,
        279095,
        279084,
        279096,
        279097,
        279098,
        283636,
        283630,
        283637,
        283631,
        283638,
        283632,
        283626,
        283639,
        283633,
        279045,
        279039,
        279046,
        295267,
        295251,
        304106,
        241882,
        242278,
        39481,
        211190,
        211191,
        211192,
        211184,
        211188,
        211189,
        429264,
        276911,
        276906,
        276530,
        365550,
        365537,
        365546,
        365531,
        365534,
        365808,
        254985,
        286815,
        254987,
        287211,
        288140,
        286514,
        254997,
        286334,
        286556,
        288142,
        254980,
        288164,
        288163,
        287954,
        286338,
        286488,
        287958,
        286545,
        286608,
        286517,
        286614,
        288162,
        288165,
        288141,
        287933,
        286615,
        219327,
        286872,
        287925,
        286702,
        286865,
        288139,
        286863,
        254992,
        287895,
        286175,
        286550,
        286496,
        254981,
        286500,
        286842,
        287216,
        286843,
        286345,
        254983,
        287228,
        286362,
        255003,
        287886,
        286542,
        286864,
        286618,
        259438,
        39480,
        350131,
        275326,
        275257,
        277399,
        261321,
        453448,
        453628,
        453523,
        453535,
        453475,
        464858,
        453571,
        453572,
        453595,
        453614,
        277362,
        266887,
        405065,
        405082,
        405090,
        446972,
        446973,
        446836,
        446884,
        446885,
        93141,
        181249,
        326257,
        221470,
        338835,
        346081,
        348240,
        343330,
        343993,
        341956,
        344799,
        341210,
        275483,
        275521,
        363812,
        363839,
        275783,
        262565,
        262566,
        262567,
        256165,
        256164,
        256163,
        267725,
        261867,
        261868,
        261869,
        261909,
        261910,
        261911,
        261905,
        261906,
        261907,
        283533,
        283532,
        262346,
        262347,
        262348,
        363821,
        285637,
        285684,
        284852,
        193792,
        193634,
        193718,
        194030,
        167122,
        172789,
        167121,
        311362,
        194034,
        194039,
        194038,
        169942,
        169943,
        371261,
        167119,
        194035,
        277204,
        277203,
        278497,
        278500,
        278441,
        278443,
        278442,
        278496,
        278499,
        454066,
        454040,
        454041,
        303818,
        303819,
        363828,
        275837,
        275870,
        380160,
        275856,
        275497,
        275779,
        380142,
        281622,
        281643,
        281646,
        218917,
        193712,
        217762,
        218969,
        344680,
        347619,
        404963,
        404956,
        104410,
        93140,
        93137,
        181258,
        181257,
        283627,
        283640,
        283634,
        283628,
        279048,
        279042,
        279036,
        279049,
        279043,
        279037,
        279050,
        279044,
        279038,
        279051,
        308570,
        344673,
        256412,
        250662,
        250661,
        250660,
        250659,
        250977,
        250974,
        250976,
        250975,
        283046,
        280428,
        280429,
        280437,
        298556,
        301318,
        301320,
        301325,
        225421,
        225422,
        225423,
        146388,
        266215,
        266216,
        92978,
        280614,
        280615,
        92979,
        224241,
        284449,
        284448,
        224240,
        147104,
        284446,
        147103,
        284445,
        224881,
        285687,
        290131,
        278923,
        292776,
        464783,
        284198,
        284197,
        285853,
        428826,
        428827,
        428828,
        428829,
        428830,
        428834,
        428836,
        428840,
        428841,
        428843,
        428845,
        428854,
        428855,
        383772,
        383773,
        383774,
        383775,
        383776,
        383777,
        428831,
        428832,
        428833,
        280683,
        280862,
        273623,
        292777,
        309949,
        295554,
        279135,
        279398,
        279399,
        279400,
        279501,
        279502,
        279397,
        279383,
        279384,
        279335,
        279382,
        279521,
        279536,
        279534,
        279537,
        279533,
        279535,
        279295,
        279551,
        279549,
        279647,
        279548,
        279550,
        279505,
        279393,
        279250,
        279391,
        279392,
        280011,
        280012,
        264671,
        254275,
        309972,
        309392,
        309965,
        291587,
        292557,
        292555,
        292599,
        292562,
        292595,
        292875,
        292786,
        292709,
        292552,
        292589,
        292610,
        293000,
        293001,
        292994,
        292974,
        292988,
        292991,
        343209,
        318511,
        279256,
        262307,
        262306,
        259442,
        259443,
        259444,
        259436,
        259437,
        259439,
        259440,
        445724,
        445290,
        446100,
        446099,
        445741,
        445742,
        445740,
        446418,
        446419,
        263671,
        263678,
        265189,
        265192,
        265198,
        262308,
        460613,
        460614,
        259445,
        389207,
        389212,
        389231,
        446502,
        446503,
        380146,
        275499,
        363819,
        380144,
        446480,
        275834,
        446481,
        275817,
        326141,
        460598,
        224882,
        460668,
        277343,
        277342,
        277345,
        466653,
        466654,
        466655,
        466572,
        466573,
        466610,
        466611,
        466749,
        466751,
        466801,
        462715,
        462713,
        462716,
        462706,
        462672,
        462669,
        462678,
        464753,
        464763,
        464764,
        464770,
        464779,
        464781,
        464967,
        304112,
        308568,
        271594,
        467404,
        467406,
        467408,
        467410,
        467412,
        467413,
        467414,
        467415,
        467471,
        467416,
        467472,
        467473,
        467417,
        467474,
        467475,
        467476,
        467484,
        467485,
        467486,
        415368,
        415369,
        415345,
        324012,
        346611,
        346960,
        346928,
        424540,
        424531,
        362336,
        362330,
        362337,
        362357,
        362363,
        362358,
        362367,
        362356,
        362365,
        362331,
        312198,
        312202,
        162723,
        162724,
        435925,
        435919,
        293239,
        304148,
        304147,
        286339)
        AND status_pagamento_produto = 'Aprovado'
GROUP BY id_produto , ano_sem
ORDER BY id_produto , dt_ajust
;
"
data <- run_query(query_dw, user_dw, password_dw, dbname_dw, host_dw)
length(unique(data$id_produto))

```
```{r}
save(data, file =  "C:\\Users\\rafael.dias\\Documents\\R_Docs\\listagem_2503_SKUs_05102018.RData")
```
```{r}
library(mafs)
library(forecast)
library(magrittr)
library(ggplot2)
library(plyr)



load(file = 'C:\\Users\\rafael.dias\\Documents\\R_Docs\\listagem_2503_SKUs_05102018.RData')
data$ano_sem <- as.numeric(data$ano_sem)

head(data,10)

# Cria um data.frame com valores exclusivos para produtos e semanas
produtos <- data.frame(id_produto=unique(data$id_produto))
nrow(produtos)
semanas <- data.frame(ano_sem=sort(unique(data$ano_sem),decreasing = FALSE))
semanas

# Une os data.frames produtos e semanas (produto cartesiano) -> criado para adicionar todas as semanas para todos os itens
a <- merge(produtos,semanas,all.y = semanas)
head(a,13)

# Inclui a coluna qt_produto ao data.frame 'a'
a$qt_produto <- 0
tail(a,13)

# Une o data.frame 'a' com o 'b', ainda com as semanas coincidentes duplicadas
b <- data.frame(merge(a,data, all = TRUE))
head(b,13)

# Elimina os NA's da coluna 'preco_medio'
b$preco_medio[which(is.nan(b$preco_medio))] <- 0
head(b,100)

# Agrupa tudo por Produto e AnoSemana
library(dplyr)
library(tidyverse)
b_x <- (b %>%
          group_by(id_produto, ano_sem) %>%
          dplyr::summarise(qt_prod=sum(qt_produto, na.rm = TRUE),
                           preco_medio=max(preco_medio, na.rm = TRUE),
                           preco_atual=max(preco_produto, na.rm = TRUE),
                           disponivel=max(disponivel, 
                                          na.rm = TRUE)))


# Elimina os valores infinitos de b_x
b_x$qt_prod <- round(b_x$qt_prod,digits = 0)
b_x$preco_medio[which(is.infinite(b_x$preco_medio))] <- 0
b_x$preco_atual[which(is.infinite(b_x$preco_atual))] <- 0
b_x$disponivel[which(is.infinite(b_x$disponivel))] <- 0
print(b_x,n=100)
b_x <- data.frame(b_x, row.names = NULL)
head(b_x)

################################################
lista_splitada <- split(b_x,b_x$id_produto)#b_x,b_x$id_produto)
save(lista_splitada,file = "C:\\Users\\rafael.dias\\Documents\\R_Docs\\Lista_Splitada_Geral_2503_SKUS.RData")
##Ajusta histórico para série temporal, por SKU
ts_geral <- lapply(lista_splitada,
                   FUN = function(lista){
                     ts(lista[,3], frequency = 53, start = c(2016, 39), end = c(2018, 38))
                   })
head(ts_geral,13)
a_a <- data.frame(0)
results <- data.frame(0)
modelo <- lapply(ts_geral,
                      FUN = function(serie_ts){
                        a_a <<- auto.arima(serie_ts, seasonal = FALSE) # colocado para que ele não considere sazonalidade - 05102018
                      })

save(modelo,file = "C:\\Users\\rafael.dias\\Documents\\R_Docs\\modelo_otimizado_2503_SKUS.RData")

previsao <- lapply(modelo,
                     FUN = function(ttt){
                       pt1 <- forecast(ttt,level = 80, h = 13)
                            })
save(previsao,file = "C:\\Users\\rafael.dias\\Documents\\R_Docs\\previsão_2018_2503_SKUs.RData")


############################################################
##Preço e base line médio com lapply:
head(lista_splitada)

library(dplyr)
sem_bl_16_i <- 201642
sem_bl_16_f <- 201646
sem_bl_17_i <- 201742
sem_bl_17_f <- 201746
sem_bf_16_1 <- 201647
sem_bf_16_2 <- 201648
sem_bf_17_1 <- 201747
sem_bf_17_2 <- 201748
lista_splitada$`18551`
zt <- function(xx){
  pm_bf1 <- data.frame(
    ano=c('2016','2017'),
    id_prd=c(max(xx[,1]),max(xx[,1])),
    Base_p=c(max(xx[,4][between(xx[,2],sem_bl_16_i,sem_bl_16_f )]),max(xx[,4][between(xx[,2],sem_bl_17_i, sem_bl_17_f)])),
    PF1=c(xx[,4][xx[,2]==sem_bf_16_1],xx[,4][xx[,2]==sem_bf_17_1]),
    PF2=c(xx[,4][xx[,2]==sem_bf_16_2],xx[,4][xx[,2]==sem_bf_17_2]),
    Base_l=c(median(xx[,3][between(xx[,2],sem_bl_16_i, sem_bl_16_f)]),median(xx[,3][between(xx[,2],sem_bl_17_i,sem_bl_17_f)])),
    BF1=c(xx[,3][xx[,2]==sem_bf_16_1],xx[,3][xx[,2]==sem_bf_17_1]),
    BF2=c(xx[,3][xx[,2]==sem_bf_16_2],xx[,3][xx[,2]==sem_bf_17_2])
  )
}
zt
ztt <- data.frame(do.call(rbind, lapply(lista_splitada, zt)),row.names = NULL)
head(ztt,10) 


ztt$qt_lift1 <- ztt$BF1[]/ztt$Base_l[]
ztt$qt_lift1[which(is.nan(ztt$qt_lift1))] <- 0
ztt$qt_lift1[which(is.infinite(ztt$qt_lift1))] <- 0
ztt$qt_lift2 <- ztt$BF2[]/ztt$Base_l[]
ztt$qt_lift2[which(is.nan(ztt$qt_lift2))] <- 0
ztt$qt_lift2[which(is.infinite(ztt$qt_lift2))] <- 0
head(ztt,10)
ztt$preco_ind1 <- ztt$PF1[]/ztt$Base_p[]
ztt$preco_ind1[which(is.nan(ztt$preco_ind1))] <- 0
ztt$preco_ind1[which(is.infinite(ztt$preco_ind1))] <- 0
ztt$preco_ind2 <- ztt$PF2[]/ztt$Base_p[]
ztt$preco_ind2[which(is.nan(ztt$preco_ind2))] <- 0
ztt$preco_ind2[which(is.infinite(ztt$preco_ind2))] <- 0
head(ztt,10)

ztt_ls <- split(ztt,ztt$id_prd)
head(ztt_ls,10)
save(ztt_ls,file = "C:\\Users\\rafael.dias\\Documents\\R_Docs\\Base_Line_Preco_e_Lifts_2503_SKUS.RData")
plot(ztt$qt_lift1 ~ ztt$preco_ind1, xlab = 'Preço Médio', ylab = 'Lift Black Friday')


##############################################################
##Separa previsões, lim inferior e superior

a13 <- lapply(previsao, function(x13){
  b <- data.frame(Previsao=x13[[4]],
                  x13[[5]],x13[[6]], 
                  row.names = NULL)
})

head(previsao,1)
head(a13,1) ## OK


a1313 <- lapply(a13, function(x13){
  b <- data.frame(Previsao=as.numeric(x13[[1]]),
                  lim_inf=x13[[2]],
                  lim_sup=x13[[3]])
})
head(a1313,1) ## OK


###############################################################

n <- names(previsao)
i <- 0
t1 <- data.frame(do.call(rbind, lapply(a1313, FUN = function(x){
  i<<-i+1
  data.frame(ano=rep('2018',13), ano_sem=rep(201839:201851), id_prd = rep(n[i],13),
             Previsao=round(x[[1]],0), lim_inf=round(ifelse(x[[2]]<0,0,x[[2]]),0), lim_sup=round(x[[3]],0))
})),row.names = NULL)

head(t1,13) ##  OK

m <- names(ztt_ls)
i <- 0
t2 <- data.frame(do.call(rbind, lapply(ztt_ls, FUN = function(y){
  i <<- i+1
  data.frame(id_prd = m[i],
             Base_Line_17 = y[6][y[2]==m[i] & y[1]=='2017'],
             Lift_1_17 = y[9][y[2]==m[i] & y[1]=='2017'],
             Lift_2_17 = y[10][y[2]==m[i] & y[1]=='2017'],
             Prec_Med = y[4][y[2]==m[i] & y[1]=='2017'])
})) ,row.names = NULL)
head(t2,16) ## OK

t12 <- data.frame(merge(t1,t2))
head(t12,16) ## OK


l <- names(lista_splitada)
i <- 0
t3 <- data.frame(do.call(rbind, lapply(lista_splitada, function(z){
  i <<- i+1
  data.frame(id_prd = l[i],
             Qt_Max = max(z[3][z[2]>201753]),
             Pre_Med_Qt_Max = z[4][z[3]==max(z[3][z[2]>201753])],
             Sem_Qt_Max = z[2][z[3]==max(z[3][z[2]>201753])],
             Preco_Atual = max(z[5]),
             Disponivel = max(z[6]),
             row.names = NULL
             )
  })))

head(t3,16) ## OK

t123 <- data.frame(merge(t12,t3))

head(t123,39) ## OK


t123_sd <- (t123 %>%
              group_by(id_prd, ano_sem) %>%
              dplyr::summarise(Disponivel = max(Disponivel),
                               Previsao = sum(Previsao),
                               lim_inf = sum(lim_inf),
                               lim_sup = sum(lim_sup),
                               Base_Line_17 = max(Base_Line_17),
                               Lift_1_17 = max(Lift_1_17),
                               Lift_2_17 = max(Lift_2_17),
                               Prec_Med = max(Prec_Med),
                               Preco_Atual = max(Preco_Atual),
                               Qt_Max = max(Qt_Max),
                               Pre_Med_Qt_Max = max(Pre_Med_Qt_Max),
                               Sem_Qt_Max = max(Sem_Qt_Max)
                               )
            )
head(t123_sd,13)


atributos_prd <- data.frame(id_prd=data$id_produto,
                            matriz=data$matriz, 
                            nome=data$nome, 
                            marca=data$marca, 
                            cor=data$cor, row.names = NULL)

atrib_prd <- (atributos_prd %>%
                group_by(id_prd) %>%
                dplyr::summarise(matriz=unique(matriz),
                                 nome=unique(nome),
                                 marca=unique(marca), 
                                 cor=unique(cor)
                ))

####################################################
#### Cálculo de Incremental:

t123_sd$Previsao_Total <- ifelse(t123_sd$Previsao>0 & t123_sd$ano_sem == 201846, round(t123_sd$Previsao[] * t123_sd$Lift_1_17[],0),
                                 ifelse(t123_sd$Previsao>0 & t123_sd$ano_sem == 201847, round(t123_sd$Previsao[] * t123_sd$Lift_2_17[],0),
                                        t123_sd$Previsao[]))
head(t123_sd,30)


t123_sd$Previsao_Total <- ifelse(t123_sd$Previsao_Total<t123_sd$Qt_Max & t123_sd$ano_sem == 201846,round(t123_sd$Previsao*2.55,0),
                                    ifelse(t123_sd$Previsao_Total<t123_sd$Qt_Max & t123_sd$ano_sem == 201847,round(t123_sd$Previsao*1.55,0),
                                           ifelse(t123_sd$Previsao_Total>(t123_sd$Qt_Max*4) & t123_sd$ano_sem == 201846,round(t123_sd$Previsao*2.55,0),
                                                  ifelse(t123_sd$Previsao_Total>(t123_sd$Qt_Max*4) & t123_sd$ano_sem == 201847,round(t123_sd$Previsao*1.55,0),
                                                         ifelse(t123_sd$Previsao_Total == 0 & t123_sd$ano_sem == 201846, t123_sd$lim_sup[],
                                                                ifelse(t123_sd$Previsao_Total == 0 & t123_sd$ano_sem == 201847, t123_sd$lim_sup[],
                                                                       ifelse(t123_sd$Previsao_Total < t123_sd$Previsao & t123_sd$ano_sem < 201837, t123_sd$Previsao,
                                                                              ifelse(t123_sd$Previsao_Total<0,0,
                                                                                     ifelse(t123_sd$Previsao_Total >= 0 & t123_sd$ano_sem >= 201848, round(t123_sd$Previsao_Total*0.55,0),
                                                                                            t123_sd$Previsao_Total[]))))))))) #

t123_sd$lim_sup <- ifelse(t123_sd$lim_sup < t123_sd$Previsao_Total & t123_sd$ano_sem == 201846, t123_sd$Previsao_Total,
                             ifelse(t123_sd$lim_sup < t123_sd$Previsao_Total & t123_sd$ano_sem == 201847, t123_sd$Previsao_Total,
                                    ifelse(t123_sd$lim_sup > 0 & t123_sd$ano_sem >= 201848, round(t123_sd$lim_sup*0.55,0),
                                           ifelse(t123_sd$lim_sup > 0 & t123_sd$ano_sem <= 201838,0,
                                                  t123_sd$lim_sup))))

t123_sd$lim_inf <-     ifelse(t123_sd$lim_inf > 0 & t123_sd$ano_sem <= 201838, 0, 
                                 ifelse(t123_sd$lim_inf > 0 & t123_sd$ano_sem >= 201848, round(t123_sd$lim_inf*0.55,0),
                                        t123_sd$lim_inf))


o <- names(lista_splitada)
i <- 0
realizado_13 <- data.frame(do.call(rbind, lapply(lista_splitada, function(z){
  i <<- i+1
  data.frame(id_prd = o[i],
             ano_sem = z[2][z[2]<=201838],
             Disponivel = max(z[6]),
             Previsao = z[3][z[2]<=201838],
             lim_inf = 0,
             lim_sup = 0,
             Base_Line_17 = 0,
             Lift_1_17 = 0,
             Lift_2_17 = 0,
             Prec_Med = 0,
             Preco_Atual = z[4][z[2]<=201838],
             Qt_Max = 0,
             Pre_Med_Qt_Max = 0,
             Sem_Qt_Max = 0,
             Previsao_Total = z[3][z[2]<=201838]
  )
})),row.names = NULL)
head(realizado_13,100)

names(realizado_13)
names(t123_sd)

datas_semanas <- data.frame(Data=sort(c(as.Date("2017/01/01"),seq(as.Date("2016/09/26"), as.Date("2018/12/24"), by = "weeks"))),
                            ano_sem=c(semanas$ano_sem,rep(201839:201851)), 
                            row.names = NULL)

t1313_sd_1 <- bind_rows(t123_sd,realizado_13)
t1313_sd_1


t1313_sd_2 <- merge(t1313_sd_1,datas_semanas)
head(t1313_sd_2,100)

t1313_sd <- merge(t1313_sd_2,atrib_prd)
tail(t1313_sd,100)

library(plyr)

t1313_sd <- arrange_all(t1313_sd)
head(t1313_sd, 100)

write.table(t1313_sd, "C:\\Users\\rafael.dias\\Documents\\R_Docs\\Prev_Final_Com_Incr_05102018_V1.csv", sep = ";", dec = ",", row.names = FALSE)

```
